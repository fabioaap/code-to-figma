name: Auditoria de SeguranÃ§a

on:
  # ExecuÃ§Ã£o semanal Ã s segundas-feiras Ã s 8h UTC
  schedule:
    - cron: '0 8 * * 1'
  
  # Em pull requests que modificam dependÃªncias
  pull_request:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'packages/*/package.json'
      - '.github/workflows/security-audit.yml'
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  security-audit:
    name: Auditoria de SeguranÃ§a
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write  # Para criar issues em caso de vulnerabilidades crÃ­ticas
    
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
      
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Configurar pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Cache do pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Instalar dependÃªncias
        run: pnpm install --frozen-lockfile
      
      - name: Executar auditoria de seguranÃ§a
        id: audit
        continue-on-error: true
        run: |
          echo "Executando auditoria de seguranÃ§a..."
          pnpm audit || true
          echo "Executando script customizado de auditoria..."
          node scripts/security-audit.js
        env:
          NODE_ENV: production
      
      - name: Upload do relatÃ³rio JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report-json-${{ github.run_number }}
          path: audit-reports/latest.json
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload do relatÃ³rio TXT
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report-txt-${{ github.run_number }}
          path: audit-reports/latest.txt
          retention-days: 90
          if-no-files-found: warn
      
      - name: Verificar vulnerabilidades crÃ­ticas
        if: failure()
        run: |
          echo "âš ï¸ Vulnerabilidades crÃ­ticas ou altas encontradas!"
          echo "Revise o relatÃ³rio de auditoria nos artifacts acima."
          exit 1
      
      - name: Comentar no PR (se aplicÃ¡vel)
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let reportContent = '';
            
            try {
              if (fs.existsSync('audit-reports/latest.txt')) {
                reportContent = fs.readFileSync('audit-reports/latest.txt', 'utf8');
                
                // Extrai apenas o resumo
                const summaryMatch = reportContent.match(/RESUMO:[\s\S]*?Total:\s+\d+/);
                const summary = summaryMatch ? summaryMatch[0] : 'RelatÃ³rio nÃ£o disponÃ­vel';
                
                const comment = `## ðŸ”’ Auditoria de SeguranÃ§a
                
            ${summary}
            
            ðŸ“Š RelatÃ³rio completo disponÃ­vel nos artifacts desta execuÃ§Ã£o.
            
            ${process.env.AUDIT_STATUS === 'failure' ? 'âš ï¸ **AtenÃ§Ã£o**: Vulnerabilidades crÃ­ticas ou altas detectadas!' : 'âœ… Auditoria concluÃ­da'}`;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('NÃ£o foi possÃ­vel postar comentÃ¡rio:', error.message);
            }
        env:
          AUDIT_STATUS: ${{ job.status }}
      
      - name: Resumo da auditoria
        if: always()
        run: |
          echo "## ðŸ”’ Auditoria de SeguranÃ§a ConcluÃ­da" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "audit-reports/latest.txt" ]; then
            echo "### ðŸ“Š Resumo" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A 10 "RESUMO:" audit-reports/latest.txt | head -n 8 >> $GITHUB_STEP_SUMMARY || echo "Resumo nÃ£o disponÃ­vel"
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ RelatÃ³rio nÃ£o gerado" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ RelatÃ³rios completos disponÃ­veis nos artifacts" >> $GITHUB_STEP_SUMMARY
